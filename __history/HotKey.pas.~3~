unit HotKey;

interface

uses
  Windows, Classes, SysUtils, Generics.Collections;

type
  TKeyCombo = array of Word;

  TKeyComboEvent = procedure(Sender: TObject; const KeyCombo: TKeyCombo) of object;

  TKeyComboEventItem = class
  public
    KeyCombo: TKeyCombo;
    OnKeyCombo: TKeyComboEvent;
  end;

  TKeyComboListenerThread = class(TThread)
  private
    FEventList: TObjectList<TKeyComboEventItem>;
    FKeyComboDown: Boolean;
    function IsKeyComboDown(const KeyCombo: TKeyCombo): Boolean;
  protected
    procedure Execute; override;
  public
    constructor Create;
    destructor Destroy; override;
    procedure AddKeyCombo(const KeyCombo: TKeyCombo; OnKeyCombo: TKeyComboEvent);
  end;

implementation

constructor TKeyComboListenerThread.Create;
begin
  inherited Create(False);
  FEventList := TObjectList<TKeyComboEventItem>.Create(True);
  FKeyComboDown := False;
end;

destructor TKeyComboListenerThread.Destroy;
begin
  FEventList.Free;
  inherited Destroy;
end;

function TKeyComboListenerThread.IsKeyComboDown(const KeyCombo: TKeyCombo): Boolean;
var
  I: Integer;
begin
  for I := Low(KeyCombo) to High(KeyCombo) do
  begin
    if GetAsyncKeyState(KeyCombo[I]) >= 0 then
    begin
      Result := False;
      Exit;
    end;
  end;
  Result := True;
end;

procedure TKeyComboListenerThread.Execute;
var
  I: Integer;
  Item: TKeyComboEventItem;
begin
  while not Terminated do
  begin
    for I := 0 to FEventList.Count - 1 do
    begin
      Item := FEventList[I];
      if IsKeyComboDown(Item.KeyCombo) then
      begin
        if not FKeyComboDown then
        begin
          FKeyComboDown := True;
          if Assigned(Item.OnKeyCombo) then
            TThread.Queue(Self,
              procedure
              begin
                Item.OnKeyCombo(Self, Item.KeyCombo);
              end
            );
        end;
      end
      else
      begin
        FKeyComboDown := False;
      end;
    end;
    Sleep(10);
  end;
end;

procedure TKeyComboListenerThread.AddKeyCombo(const KeyCombo: TKeyCombo; OnKeyCombo: TKeyComboEvent);
var
  Item: TKeyComboEventItem;
begin
  Item := TKeyComboEventItem.Create;
  Item.KeyCombo := KeyCombo;
  Item.OnKeyCombo := OnKeyCombo;
  FEventList.Add(Item);
end;

end.

